<!-- VIDEO PLAYER PAGE -->
<%
// Use episodeNumber and season passed from server route
const currentSeason = content.type === 'series' && typeof season !== 'undefined' && season !== null ? season : (content.type === 'series' ? 1 : null);
const currentEpisodeNumber = content.type === 'series' && typeof episodeNumber !== 'undefined' && episodeNumber !== null ? episodeNumber : (content.type === 'series' ? 1 : null);
const currentEpisodeData = currentSeason !== null && currentEpisodeNumber !== null && content.episodes ? 
  content.episodes.find(ep => ep.season === currentSeason && ep.episodeNumber === currentEpisodeNumber) : null;
const currentEpisodeIndex = currentEpisodeData && content.episodes ? content.episodes.indexOf(currentEpisodeData) : null;
const videoSource = (currentEpisodeData && currentEpisodeData.videoUrl) || content.videoUrl;
const nextEpisodeIndex = currentEpisodeIndex !== null && content.episodes && currentEpisodeIndex < content.episodes.length - 1 ? currentEpisodeIndex + 1 : null;
const nextEpisode = nextEpisodeIndex !== null && content.episodes ? content.episodes[nextEpisodeIndex] : null;
%>

<div class="player-page">
  <!-- Back Button -->
  <div class="player-header" id="playerHeader">
    <a href="/content/<%= content._id %>" class="btn-back">
      <i class="bi bi-arrow-right"></i> חזור
    </a>
    <h3>
      <%= content.title %>
      <% if (currentEpisodeData) { %>
        <span class="text-muted"> - עונה <%= currentEpisodeData.season %> פרק <%= currentEpisodeData.episodeNumber %>: <%= currentEpisodeData.title %></span>
      <% } %>
    </h3>
    <% if (content.type === 'series') { %>
      <button id="toggleEpisodesBtn" class="btn btn-outline-light btn-sm">
        <i class="bi bi-list"></i> פרקים
      </button>
    <% } %>
  </div>

  <!-- Video Player -->
  <div class="player-wrapper">
    <% if (videoSource) { %>
      <video id="videoPlayer" class="video-player">
        <source src="<%= videoSource %>" type="video/mp4">
        הדפדפן שלך לא תומך בוידאו
      </video>

      <!-- Custom Controls -->
      <div class="player-controls" id="playerControls">
        <!-- Progress Bar -->
        <div class="progress-bar-container" id="progressBarContainer">
          <div class="progress-bar-fill" id="progressFill"></div>
          <div class="progress-bar-hover" id="progressHover"></div>
        </div>

        <!-- Control Buttons -->
        <div class="controls-row">
          <div class="controls-left">
            <button id="playPauseBtn" title="נגן/השהה">
              <i class="bi bi-play-fill"></i>
            </button>
            <button id="rewindBtn" title="אחורה 10 שניות">
              <i class="bi bi-skip-backward-fill"></i>
            </button>
            <button id="forwardBtn" title="קדימה 10 שניות">
              <i class="bi bi-skip-forward-fill"></i>
            </button>
            <% if (nextEpisode) { %>
              <button id="nextEpisodeBtn" title="פרק הבא" onclick="goToNextEpisode()">
                <i class="bi bi-skip-end-fill"></i> פרק הבא
              </button>
            <% } %>
            <div class="volume-control">
              <button id="volumeBtn" title="שקט">
                <i class="bi bi-volume-up-fill"></i>
              </button>
              <input type="range" id="volumeSlider" min="0" max="100" value="100" class="volume-slider">
            </div>
            <span class="time-display">
              <span id="currentTime">0:00</span> / <span id="duration">0:00</span>
            </span>
          </div>

          <div class="controls-right">
            <% if (content.type === 'series') { %>
              <button id="episodesListBtn" title="רשימת פרקים" onclick="toggleEpisodesOverlay()">
                <i class="bi bi-list-ul"></i>
              </button>
            <% } %>
            <button id="settingsBtn" title="הגדרות">
              <i class="bi bi-gear-fill"></i>
            </button>
            <button id="fullscreenBtn" title="מסך מלא">
              <i class="bi bi-fullscreen"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Next Episode Countdown -->
      <% if (nextEpisode) { %>
        <div id="nextEpisodeCountdown" class="next-episode-countdown" style="display: none;">
          <div class="countdown-content">
            <h3>פרק הבא</h3>
            <p><%= nextEpisode.title %></p>
            <div class="countdown-timer">
              <span id="countdownNumber">10</span>
            </div>
            <div class="countdown-buttons">
              <button class="btn btn-play" onclick="goToNextEpisode()">
                <i class="bi bi-play-fill"></i> נגן עכשיו
              </button>
              <button class="btn btn-outline-light" onclick="cancelCountdown()">
                ביטול
              </button>
            </div>
          </div>
        </div>
      <% } %>
    <% } else { %>
      <!-- No Video Message -->
      <div class="no-video-message">
        <i class="bi bi-film"></i>
        <p>קובץ וידאו לא זמין</p>
        <a href="/content/<%= content._id %>" class="btn btn-netflix">חזור לעמוד התוכן</a>
      </div>
    <% } %>
  </div>

  <!-- Episodes Overlay (for series) -->
  <% if (content.type === 'series' && content.episodes && content.episodes.length > 0) { %>
    <div id="episodesOverlay" class="episodes-overlay">
      <div class="episodes-overlay-header">
        <h3>פרקים</h3>
        <button onclick="toggleEpisodesOverlay()" class="btn-close-overlay">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>
      <div class="episodes-overlay-content">
        <% content.episodes.forEach((episode, index) => { %>
          <div class="episode-overlay-item <%= currentEpisodeData && episode.season === currentEpisodeData.season && episode.episodeNumber === currentEpisodeData.episodeNumber ? 'active' : '' %>" 
               onclick="playEpisode(<%= episode.season %>, <%= episode.episodeNumber %>)">
            <div class="episode-overlay-thumbnail">
              <img src="<%= episode.imageUrl || content.imageUrl || '/img/placeholder.png' %>" alt="<%= episode.title %>">
              <div class="episode-overlay-play">
                <i class="bi bi-play-fill"></i>
              </div>
              <div class="episode-overlay-progress" id="overlay-progress-s<%= episode.season %>e<%= episode.episodeNumber %>">
                <div class="episode-overlay-progress-fill"></div>
              </div>
            </div>
            <div class="episode-overlay-info">
              <div class="episode-overlay-number">עונה <%= episode.season %> פרק <%= episode.episodeNumber %></div>
              <div>
                <h5><%= episode.title %></h5>
                <% if (episode.description) { %>
                  <p><%= episode.description %></p>
                <% } %>
                <div class="episode-overlay-meta">
                  <% if (episode.duration) { %>
                    <span><i class="bi bi-clock"></i> <%= episode.duration %></span>
                  <% } %>
                </div>
              </div>
            </div>
          </div>
        <% }) %>
      </div>
    </div>
  <% } %>

  <!-- Content Info Below Player -->
  <div class="player-info-section">
    <div class="container">
      <div class="row">
        <div class="col-md-8">
          <h2><%= content.title %></h2>
          <% if (content.description) { %>
            <p class="text-muted"><%= content.description %></p>
          <% } %>
        </div>
        <div class="col-md-4">
          <% if (content.director) { %>
            <p><strong>במאי:</strong> <%= content.director %></p>
          <% } %>
          <% if (content.actors && content.actors.length > 0) { %>
            <p><strong>שחקנים:</strong> <%= content.actors.slice(0, 3).join(', ') %></p>
          <% } %>
          <% if (content.genres && content.genres.length > 0) { %>
            <p><strong>ז'אנרים:</strong> <%= content.genres.join(', ') %></p>
          <% } %>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Similar Content (shown after play) -->
<!-- Similar Content (shown after play) -->
<section class="similar-content mt-5" id="similarAfterPlay" style="display:none;">
  <h2 class="section-title">תכנים דומים שאתה עשוי לאהוב</h2>
  <div class="content-row" id="similarRow"></div>
</section>

<!-- helper: embed first genre for client JS -->
<div id="playerMeta" data-first-genre="<%= (content.genres && content.genres.length) ? content.genres[0] : '' %>" style="display:none;"></div>

<style>
.player-page {
  background-color: black;
  min-height: 100vh;
  padding: 0;
}

.player-header {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  padding: 1rem 2rem;
  background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, transparent 100%);
  display: flex;
  align-items: center;
  gap: 2rem;
  z-index: 1000;
  transition: opacity 0.3s;
}

.btn-back {
  background: none;
  border: none;
  color: white;
  font-size: 1.5rem;
  cursor: pointer;
  text-decoration: none;
  transition: var(--transition);
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.btn-back:hover {
  color: var(--netflix-red);
}

.player-header h3 {
  color: white;
  margin: 0;
  font-size: 1.2rem;
}

.player-wrapper {
  position: relative;
  width: 100%;
  max-width: 100vw;
  margin: 0 auto;
  background-color: black;
}

.video-player {
  width: 100%;
  height: 100vh;
  object-fit: contain;
  display: block;
}

.video-player::-webkit-media-controls {
  display: none !important;
}

.video-player::-webkit-media-controls-enclosure {
  display: none !important;
}

.player-controls {
  position: absolute;
  bottom: 0;
  left: 0;
  width: 100%;
  background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, transparent 100%);
  padding: 3rem 2rem 1rem;
  opacity: 0;
  transition: opacity 0.3s;
}

.player-wrapper:hover .player-controls,
.player-controls:hover {
  opacity: 1;
}

.progress-bar-container {
  width: 100%;
  height: 6px;
  background-color: rgba(255,255,255,0.3);
  border-radius: 10px;
  cursor: pointer;
  margin-bottom: 1rem;
  position: relative;
}

.progress-bar-fill {
  height: 100%;
  background-color: var(--netflix-red);
  border-radius: 10px;
  width: 0%;
  transition: width 0.1s;
  position: relative;
}

.progress-bar-hover {
  position: absolute;
  top: 0;
  left: 0;
  height: 100%;
  background-color: rgba(255,255,255,0.5);
  border-radius: 10px;
  width: 0%;
  pointer-events: none;
}

.controls-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.controls-left,
.controls-right {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.player-controls button {
  background: none;
  border: none;
  color: white;
  font-size: 1.5rem;
  cursor: pointer;
  padding: 0.5rem;
  transition: var(--transition);
}

.player-controls button:hover {
  color: var(--netflix-red);
  transform: scale(1.2);
}

.volume-control {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.volume-slider {
  width: 80px;
  height: 4px;
  -webkit-appearance: none;
  appearance: none;
  background: rgba(255,255,255,0.3);
  outline: none;
  border-radius: 10px;
}

.volume-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 12px;
  height: 12px;
  background: white;
  cursor: pointer;
  border-radius: 50%;
}

.volume-slider::-moz-range-thumb {
  width: 12px;
  height: 12px;
  background: white;
  cursor: pointer;
  border-radius: 50%;
  border: none;
}

.time-display {
  color: white;
  font-size: 0.9rem;
  margin-right: 1rem;
}

.no-video-message {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
  color: white;
}

.no-video-message i {
  font-size: 5rem;
  color: #666;
  margin-bottom: 1rem;
}

.no-video-message p {
  font-size: 1.5rem;
  margin-bottom: 1.5rem;
}

.episodes-section {
  padding: 2rem;
  background-color: var(--netflix-black);
}

.episodes-section h4 {
  color: white;
  margin-bottom: 1.5rem;
}

.episodes-list {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.episode-item {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 1rem;
  background-color: var(--netflix-dark);
  border-radius: 8px;
  transition: var(--transition);
  cursor: pointer;
}

.episode-item:hover {
  background-color: var(--netflix-gray);
  transform: translateX(-5px);
}

.episode-number {
  font-size: 1.5rem;
  font-weight: bold;
  color: var(--netflix-light-gray);
  min-width: 40px;
  text-align: center;
}

.episode-info {
  flex: 1;
}

.episode-info h5 {
  color: white;
  margin-bottom: 0.25rem;
  font-size: 1rem;
}

.episode-info p {
  color: var(--netflix-light-gray);
  margin: 0;
  font-size: 0.9rem;
}

.player-info-section {
  background-color: var(--netflix-black);
  padding: 2rem 0;
  color: white;
}

/* Episodes Overlay */
.episodes-overlay {
  position: fixed;
  top: 0;
  right: -100%;
  width: 450px;
  max-width: 90vw;
  height: 100vh;
  background: rgba(20, 20, 20, 0.98);
  backdrop-filter: blur(10px);
  z-index: 2000;
  transition: right 0.3s ease;
  overflow-y: auto;
  box-shadow: -5px 0 20px rgba(0,0,0,0.5);
}

.episodes-overlay.open {
  right: 0;
}

.episodes-overlay-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1.5rem;
  border-bottom: 1px solid rgba(255,255,255,0.1);
  position: sticky;
  top: 0;
  background: rgba(20, 20, 20, 0.98);
  z-index: 1;
}

.episodes-overlay-header h3 {
  color: white;
  margin: 0;
  font-size: 1.4rem;
}

.btn-close-overlay {
  background: none;
  border: none;
  color: white;
  font-size: 1.5rem;
  cursor: pointer;
  padding: 0.5rem;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: var(--transition);
}

.btn-close-overlay:hover {
  color: var(--netflix-red);
}

.episodes-overlay-content {
  padding: 1rem;
}

.episode-overlay-item {
  display: flex;
  gap: 1rem;
  padding: 1rem;
  cursor: pointer;
  border-radius: 8px;
  transition: var(--transition);
  margin-bottom: 1rem;
  background: rgba(255,255,255,0.05);
}

.episode-overlay-item:hover {
  background: rgba(255,255,255,0.1);
  transform: translateX(-5px);
}

.episode-overlay-item.active {
  background: var(--netflix-red);
}

.episode-overlay-thumbnail {
  position: relative;
  width: 140px;
  height: 80px;
  flex-shrink: 0;
  border-radius: 4px;
  overflow: hidden;
}

.episode-overlay-thumbnail img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.episode-overlay-play {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 40px;
  height: 40px;
  background: rgba(0,0,0,0.7);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: var(--transition);
}

.episode-overlay-item:hover .episode-overlay-play {
  opacity: 1;
}

.episode-overlay-play i {
  color: white;
  font-size: 1.2rem;
}

.episode-overlay-progress {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: rgba(255,255,255,0.2);
}

.episode-overlay-progress-fill {
  height: 100%;
  background: var(--netflix-red);
  transition: width 0.3s ease;
}

.episode-overlay-progress-fill.completed {
  background: #46d369;
}

.episode-overlay-info {
  flex: 1;
  display: flex;
  gap: 0.75rem;
  align-items: flex-start;
}

.episode-overlay-number {
  font-size: 1.5rem;
  font-weight: bold;
  color: var(--netflix-light-gray);
  min-width: 30px;
}

.episode-overlay-item.active .episode-overlay-number {
  color: white;
}

.episode-overlay-info h5 {
  color: white;
  margin: 0 0 0.5rem 0;
  font-size: 1rem;
}

.episode-overlay-info p {
  color: var(--netflix-light-gray);
  margin: 0 0 0.5rem 0;
  font-size: 0.85rem;
  line-height: 1.4;
}

.episode-overlay-meta {
  display: flex;
  gap: 1rem;
  font-size: 0.8rem;
  color: var(--netflix-light-gray);
}

.episode-overlay-meta i {
  margin-left: 0.25rem;
}

/* Next Episode Countdown */
.next-episode-countdown {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.9);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1500;
}

.countdown-content {
  text-align: center;
  color: white;
}

.countdown-content h3 {
  font-size: 2rem;
  margin-bottom: 0.5rem;
}

.countdown-content p {
  font-size: 1.2rem;
  color: var(--netflix-light-gray);
  margin-bottom: 2rem;
}

.countdown-timer {
  font-size: 4rem;
  font-weight: bold;
  margin-bottom: 2rem;
  color: var(--netflix-red);
}

.countdown-buttons {
  display: flex;
  gap: 1rem;
  justify-content: center;
}

.countdown-buttons .btn {
  padding: 0.75rem 2rem;
  font-size: 1rem;
}

.btn-play {
  background: var(--netflix-red);
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  transition: var(--transition);
}

.btn-play:hover {
  background: #c11119;
}

#nextEpisodeBtn {
  background: rgba(255,255,255,0.2);
  padding: 0.5rem 1rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.95rem;
}

#nextEpisodeBtn:hover {
  background: rgba(255,255,255,0.3);
}

#toggleEpisodesBtn {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

#episodesListBtn {
  background: rgba(255,255,255,0.2);
}

#episodesListBtn:hover {
  background: rgba(255,255,255,0.3);
}

.player-info-section h2 {
  color: white;
  margin-bottom: 1rem;
}

.player-info-section p {
  margin-bottom: 0.5rem;
}

/* Hide main navbar and footer */
#mainNav,
footer {
  display: none;
}

main.container {
  margin: 0 !important;
  padding: 0 !important;
  max-width: 100% !important;
}

/* Mobile Responsive */
@media (max-width: 768px) {
  .player-header {
    padding: 1rem;
  }
  
  .btn-back {
    font-size: 1.2rem;
  }
  
  .player-header h3 {
    font-size: 1rem;
  }
  
  .player-controls {
    padding: 2rem 1rem 0.5rem;
  }
  
  .controls-left,
  .controls-right {
    gap: 0.5rem;
  }
  
  .player-controls button {
    font-size: 1.2rem;
    padding: 0.3rem;
  }
  
  .volume-control {
    display: none;
  }
  
  .time-display {
    font-size: 0.8rem;
  }
}
</style>

<script>
// Video Player Controls
const video = document.getElementById('videoPlayer');
const playPauseBtn = document.getElementById('playPauseBtn');
const rewindBtn = document.getElementById('rewindBtn');
const forwardBtn = document.getElementById('forwardBtn');
const volumeBtn = document.getElementById('volumeBtn');
const volumeSlider = document.getElementById('volumeSlider');
const fullscreenBtn = document.getElementById('fullscreenBtn');
const progressBarContainer = document.getElementById('progressBarContainer');
const progressFill = document.getElementById('progressFill');
const progressHover = document.getElementById('progressHover');
const currentTimeEl = document.getElementById('currentTime');
const durationEl = document.getElementById('duration');
const playerControls = document.getElementById('playerControls');
const playerHeader = document.querySelector('.player-header');

if (video) {
  // Play/Pause
  playPauseBtn.addEventListener('click', togglePlayPause);
  video.addEventListener('click', togglePlayPause);
  
  function togglePlayPause() {
    if (video.paused) {
      video.play();
      playPauseBtn.innerHTML = '<i class="bi bi-pause-fill"></i>';
    } else {
      video.pause();
      playPauseBtn.innerHTML = '<i class="bi bi-play-fill"></i>';
    }
  }

  // Rewind 10 seconds
  rewindBtn.addEventListener('click', () => {
    video.currentTime = Math.max(0, video.currentTime - 10);
  });

  // Forward 10 seconds
  forwardBtn.addEventListener('click', () => {
    video.currentTime = Math.min(video.duration, video.currentTime + 10);
  });

  // Volume Control
  volumeBtn.addEventListener('click', () => {
    video.muted = !video.muted;
    updateVolumeIcon();
  });

  volumeSlider.addEventListener('input', (e) => {
    video.volume = e.target.value / 100;
    video.muted = false;
    updateVolumeIcon();
  });

  function updateVolumeIcon() {
    if (video.muted || video.volume === 0) {
      volumeBtn.innerHTML = '<i class="bi bi-volume-mute-fill"></i>';
    } else if (video.volume < 0.5) {
      volumeBtn.innerHTML = '<i class="bi bi-volume-down-fill"></i>';
    } else {
      volumeBtn.innerHTML = '<i class="bi bi-volume-up-fill"></i>';
    }
  }

  // Fullscreen
  fullscreenBtn.addEventListener('click', () => {
    if (!document.fullscreenElement) {
      document.querySelector('.player-wrapper').requestFullscreen();
      fullscreenBtn.innerHTML = '<i class="bi bi-fullscreen-exit"></i>';
    } else {
      document.exitFullscreen();
      fullscreenBtn.innerHTML = '<i class="bi bi-fullscreen"></i>';
    }
  });

  // Update progress bar
  video.addEventListener('timeupdate', () => {
    const progress = (video.currentTime / video.duration) * 100;
    progressFill.style.width = progress + '%';
    currentTimeEl.textContent = formatTime(video.currentTime);
  });

  // Set duration
  video.addEventListener('loadedmetadata', () => {
    durationEl.textContent = formatTime(video.duration);
  });

  // Progress bar hover effect
  progressBarContainer.addEventListener('mousemove', (e) => {
    const rect = progressBarContainer.getBoundingClientRect();
    const pos = (e.clientX - rect.left) / rect.width;
    progressHover.style.width = (pos * 100) + '%';
  });

  progressBarContainer.addEventListener('mouseleave', () => {
    progressHover.style.width = '0%';
  });

  // Click on progress bar
  progressBarContainer.addEventListener('click', (e) => {
    const rect = progressBarContainer.getBoundingClientRect();
    const pos = (e.clientX - rect.left) / rect.width;
    video.currentTime = pos * video.duration;
  });

  // Keyboard shortcuts
  document.addEventListener('keydown', (e) => {
    switch(e.code) {
      case 'Space':
        e.preventDefault();
        togglePlayPause();
        break;
      case 'ArrowLeft':
        video.currentTime = Math.max(0, video.currentTime - 5);
        break;
      case 'ArrowRight':
        video.currentTime = Math.min(video.duration, video.currentTime + 5);
        break;
      case 'ArrowUp':
        e.preventDefault();
        video.volume = Math.min(1, video.volume + 0.1);
        volumeSlider.value = video.volume * 100;
        break;
      case 'ArrowDown':
        e.preventDefault();
        video.volume = Math.max(0, video.volume - 0.1);
        volumeSlider.value = video.volume * 100;
        break;
      case 'KeyF':
        fullscreenBtn.click();
        break;
      case 'KeyM':
        volumeBtn.click();
        break;
    }
  });

  // Format time helper
  function formatTime(seconds) {
    if (isNaN(seconds)) return '0:00';
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
  }

  // Auto-hide controls
  let controlsTimeout;
  let mouseMoving = false;
  
  document.querySelector('.player-wrapper').addEventListener('mousemove', () => {
    mouseMoving = true;
    playerControls.style.opacity = '1';
    playerHeader.style.opacity = '1';
    
    clearTimeout(controlsTimeout);
    
    controlsTimeout = setTimeout(() => {
      if (!video.paused && mouseMoving) {
        playerControls.style.opacity = '0';
        playerHeader.style.opacity = '0';
        mouseMoving = false;
      }
    }, 3000);
  });

  // Keep controls visible when paused
  video.addEventListener('pause', () => {
    playerControls.style.opacity = '1';
    playerHeader.style.opacity = '1';
  });

  video.addEventListener('play', () => {
    clearTimeout(controlsTimeout);
    controlsTimeout = setTimeout(() => {
      if (mouseMoving === false) {
        playerControls.style.opacity = '0';
        playerHeader.style.opacity = '0';
      }
    }, 3000);
  });

  // Track watch progress
  const contentId = '<%= content._id %>';
  const contentType = '<%= content.type %>';
  const urlParams = new URLSearchParams(window.location.search);
  const currentSeason = contentType === 'series' ? (parseInt(urlParams.get('season')) || 1) : null;
  const currentEpisodeNumber = contentType === 'series' ? (parseInt(urlParams.get('episode')) || 1) : null;
  let lastSavedTime = 0;
  let countdownInterval = null;

  // Try to load saved progress for this profile
  (async function loadSavedProgress() {
    try {
      let url = `/api/watch/${contentId}`;
      if (currentSeason !== null && currentEpisodeNumber !== null) {
        url += `?season=${currentSeason}&episode=${currentEpisodeNumber}`;
      }
      const res = await fetch(url);
      if (!res.ok) return;
      const json = await res.json();
      if (json && json.watch && typeof json.watch.timestamp !== 'undefined') {
        const savedTime = Number(json.watch.timestamp) || 0;
        // If metadata already loaded, set directly; otherwise wait for loadedmetadata
        if (!isNaN(video.duration) && video.duration > 0) {
          video.currentTime = Math.min(savedTime, video.duration - 1);
        } else {
          video.addEventListener('loadedmetadata', () => {
            video.currentTime = Math.min(savedTime, video.duration - 1);
          });
        }
      }
    } catch (err) {
      console.error('Error loading saved progress:', err);
    }
  })();

  // Load episode progress for overlay
  (async function loadEpisodeProgress() {
    if (contentType !== 'series') return;
    try {
      const res = await fetch(`/api/watch/${contentId}/episodes`);
      if (!res.ok) return;
      const json = await res.json();
      if (json && json.episodes) {
        json.episodes.forEach(ep => {
          const progressEl = document.getElementById(`overlay-progress-s${ep.season}e${ep.episodeNumber}`);
          if (progressEl) {
            const fill = progressEl.querySelector('.episode-overlay-progress-fill');
            if (fill) {
              fill.style.width = `${ep.progress}%`;
              if (ep.progress >= 95) {
                fill.classList.add('completed');
              }
            }
          }
        });
      }
    } catch (err) {
      console.error('Error loading episode progress:', err);
    }
  })();

  video.addEventListener('timeupdate', () => {
    // Save progress every 10 seconds
    if (Math.floor(video.currentTime) % 10 === 0 && 
        Math.floor(video.currentTime) !== lastSavedTime) {
      lastSavedTime = Math.floor(video.currentTime);
      saveWatchProgress();
    }

    // Show next episode countdown when near end (last 30 seconds)
    if (contentType === 'series' && document.getElementById('nextEpisodeCountdown')) {
      const timeRemaining = video.duration - video.currentTime;
      if (timeRemaining <= 30 && timeRemaining > 0 && !countdownInterval) {
        showNextEpisodeCountdown();
      }
    }
  });

  async function saveWatchProgress() {
    const progress = (video.currentTime / video.duration) * 100;
    
    try {
      const body = {
        progress: progress,
        timestamp: video.currentTime
      };
      if (currentEpisodeNumber !== null && currentSeason !== null) {
        body.episodeNumber = currentEpisodeNumber;
        body.season = currentSeason;
      }
      
      await fetch(`/api/watch/${contentId}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(body)
      });
    } catch (error) {
      console.error('Error saving watch progress:', error);
    }
  }

  // Save on page unload
  window.addEventListener('beforeunload', saveWatchProgress);
}

// Episode management functions (global scope)
function toggleEpisodesOverlay() {
  const overlay = document.getElementById('episodesOverlay');
  if (overlay) {
    overlay.classList.toggle('open');
  }
}

function playEpisode(season, episodeNumber) {
  const contentId = '<%= content._id %>';
  window.location.href = `/player/${contentId}?season=${season}&episode=${episodeNumber}`;
}

function goToNextEpisode() {
  <% if (nextEpisode) { %>
  const contentId = '<%= content._id %>';
  window.location.href = `/player/${contentId}?season=<%= nextEpisode.season %>&episode=<%= nextEpisode.episodeNumber %>`;
  <% } %>
}

function showNextEpisodeCountdown() {
  const countdown = document.getElementById('nextEpisodeCountdown');
  if (!countdown || countdownInterval) return;
  
  countdown.style.display = 'flex';
  let seconds = 10;
  const numberEl = document.getElementById('countdownNumber');
  
  countdownInterval = setInterval(() => {
    seconds--;
    if (numberEl) numberEl.textContent = seconds;
    
    if (seconds <= 0) {
      clearInterval(countdownInterval);
      goToNextEpisode();
    }
  }, 1000);
}

function cancelCountdown() {
  const countdown = document.getElementById('nextEpisodeCountdown');
  if (countdown) countdown.style.display = 'none';
  if (countdownInterval) {
    clearInterval(countdownInterval);
    countdownInterval = null;
  }
}

// Fetch and render similar content on first play
// Fetch and render similar content on first play
(function setupSimilarOnPlay() {
  const playedFlagKey = 'similar_shown_' + '<%= content._id %>';
  let shown = false;
  const similarSection = document.getElementById('similarAfterPlay');
  const similarRow = document.getElementById('similarRow');
  // read first genre from helper meta element
  const metaEl = document.getElementById('playerMeta');
  const firstGenre = metaEl ? metaEl.dataset.firstGenre : '';

  if (!firstGenre) return;

  if (typeof video === 'undefined' || !video) return;

  video.addEventListener('play', async () => {
    if (shown) return;
    shown = true;
    try {
      const res = await fetch(`/api/genre/${encodeURIComponent(firstGenre)}?skip=0&limit=6`);
      if (!res.ok) return;
      const json = await res.json();
      const items = json.items || [];
      if (items.length === 0) return;
      similarRow.innerHTML = items.map(it => `
        <div class="content-card">
          <a href="/content/${it._id}"><img src="${it.imageUrl || '/img/placeholder.png'}" alt="${it.title || ''}"></a>
          <div class="content-card-body">
            <h5 class="content-card-title">${it.title || 'תוכן'}</h5>
            <div class="d-flex gap-2">
              <a href="/player/${it._id}" class="btn btn-play btn-sm"><i class="bi bi-play-fill"></i></a>
              <a href="/content/${it._id}" class="btn btn-info btn-sm"><i class="bi bi-info-circle"></i></a>
            </div>
          </div>
        </div>
      `).join('');
      similarSection.style.display = 'block';
    } catch (err) {
      console.error('Error loading similar content:', err);
    }
  }, { once: true });
})();
</script>