<!-- GENRE PAGE -->

<div class="genre-page">
  <div class="genre-header">
    <h1>
      <i class="bi bi-collection-play"></i> <%= genre %>
    </h1>
    <p class="text-muted">גלה את כל התכנים בקטגוריה</p>
    
    <!-- Filters and Sorting -->
    <div class="filters-row">
      <div class="filter-group">
        <label for="sortSelect">
          <i class="bi bi-sort-down"></i> מיון:
        </label>
        <select id="sortSelect" class="form-select form-select-sm">
          <option value="newest">חדש ביותר</option>
          <option value="rating">דירוג גבוה</option>
          <option value="popular">פופולרי</option>
        </select>
      </div>
      
      <div class="filter-group">
        <label for="watchedFilter">
          <i class="bi bi-filter"></i> סינון:
        </label>
        <select id="watchedFilter" class="form-select form-select-sm">
          <option value="all">הכל</option>
          <option value="unwatched">לא נצפה</option>
          <option value="watched">כבר נצפה</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Content Grid -->
  <div id="contentGrid" class="content-grid">
    <% if (contents && contents.length > 0) { %>
      <% contents.forEach(item => { %>
        <div class="content-card" data-content-id="<%= item._id %>">
          <a href="/content/<%= item._id %>">
            <img src="<%= item.imageUrl || '/img/placeholder.png' %>" alt="<%= item.title %>">
          </a>
          <div class="content-card-body">
            <h5 class="content-card-title"><%= item.title %></h5>
            <% if (item.year) { %>
              <small class="text-muted">
                <i class="bi bi-calendar3"></i> <%= item.year %>
              </small>
            <% } %>
            <% if (item.imdbRating) { %>
              <small class="text-muted ms-2">
                <i class="bi bi-star-fill text-warning"></i> <%= item.imdbRating %>
              </small>
            <% } %>
            <div class="d-flex gap-2 mt-2">
              <a href="/player/<%= item._id %>" class="btn btn-play btn-sm">
                <i class="bi bi-play-fill"></i>
              </a>
              <a href="/content/<%= item._id %>" class="btn btn-info btn-sm">
                <i class="bi bi-info-circle"></i>
              </a>
            </div>
          </div>
        </div>
      <% }) %>
    <% } %>
  </div>

  <!-- Loading Indicator -->
  <div id="loadingIndicator" class="text-center py-4" style="display: none;">
    <div class="spinner-border text-danger" role="status">
      <span class="visually-hidden">טוען...</span>
    </div>
  </div>

  <!-- No More Content -->
  <div id="noMoreContent" class="text-center py-4" style="display: none;">
    <i class="bi bi-check-circle" style="font-size: 3rem; color: var(--netflix-red);"></i>
    <p class="text-muted mt-2">זה הכל! אין עוד תכנים להציג</p>
  </div>
</div>

<style>
.genre-page {
  padding: 2rem 4%;
  min-height: 100vh;
}

.genre-header {
  margin-bottom: 2rem;
  padding-bottom: 1rem;
  border-bottom: 2px solid var(--netflix-gray);
}

.genre-header h1 {
  color: white;
  font-size: 2.5rem;
  margin-bottom: 0.5rem;
  display: flex;
  align-items: center;
  gap: 1rem;
}

.filters-row {
  display: flex;
  gap: 2rem;
  margin-top: 1.5rem;
  flex-wrap: wrap;
}

.filter-group {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.filter-group label {
  color: var(--netflix-light-gray);
  font-size: 0.9rem;
  white-space: nowrap;
}

.filter-group select {
  background-color: var(--netflix-dark);
  color: white;
  border: 1px solid var(--netflix-gray);
  min-width: 150px;
}

.filter-group select:focus {
  border-color: var(--netflix-red);
  box-shadow: 0 0 0 0.2rem rgba(229, 9, 20, 0.25);
}

.content-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 1.5rem;
  margin-bottom: 2rem;
}

@media (max-width: 768px) {
  .genre-page {
    padding: 2rem 2%;
  }
  
  .genre-header h1 {
    font-size: 1.8rem;
  }
  
  .content-grid {
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 1rem;
  }
}
</style>

<script>
// Infinite Scroll Implementation
let skip = <%= contents.length %>;
const genre = '<%= genre %>';
const batchSize = 12;
let loading = false;
let noMore = false;
let currentSort = 'newest';
let currentFilter = 'all';
let watchedContentIds = [];

// Get watched content for current profile
(async function fetchWatchedContent() {
  try {
    const res = await fetch('/api/profile/watched');
    if (res.ok) {
      const data = await res.json();
      watchedContentIds = data.watched || [];
      applyFilters();
    }
  } catch (err) {
    console.error('Error fetching watched content:', err);
  }
})();

// Sort and Filter handlers
document.getElementById('sortSelect').addEventListener('change', (e) => {
  currentSort = e.target.value;
  reloadContent();
});

document.getElementById('watchedFilter').addEventListener('change', (e) => {
  currentFilter = e.target.value;
  applyFilters();
});

function applyFilters() {
  const cards = document.querySelectorAll('.content-card');
  cards.forEach(card => {
    const contentId = card.dataset.contentId;
    const isWatched = watchedContentIds.includes(contentId);
    
    if (currentFilter === 'all') {
      card.style.display = '';
    } else if (currentFilter === 'watched' && isWatched) {
      card.style.display = '';
    } else if (currentFilter === 'unwatched' && !isWatched) {
      card.style.display = '';
    } else {
      card.style.display = 'none';
    }
  });
}

async function reloadContent() {
  const grid = document.getElementById('contentGrid');
  grid.innerHTML = '';
  skip = 0;
  noMore = false;
  await loadMoreContent();
}

// Intersection Observer for infinite scroll
const observer = new IntersectionObserver((entries) => {
  entries.forEach(entry => {
    if (entry.isIntersecting && !loading && !noMore) {
      loadMoreContent();
    }
  });
}, {
  rootMargin: '100px'
});

// Observe the loading indicator
const loadingIndicator = document.getElementById('loadingIndicator');
observer.observe(loadingIndicator);

async function loadMoreContent() {
  if (loading || noMore) return;
  
  loading = true;
  loadingIndicator.style.display = 'block';
  
  try {
    const url = `/api/genre/${encodeURIComponent(genre)}?skip=${skip}&limit=${batchSize}&sort=${currentSort}`;
    const response = await fetch(url);
    const data = await response.json();
    
    if (data.items && data.items.length > 0) {
      const grid = document.getElementById('contentGrid');
      
      data.items.forEach(item => {
        const card = createContentCard(item);
        grid.appendChild(card);
      });
      
      skip += data.items.length;
      applyFilters();
      
      if (data.items.length < batchSize) {
        noMore = true;
        document.getElementById('noMoreContent').style.display = 'block';
      }
    } else {
      noMore = true;
      document.getElementById('noMoreContent').style.display = 'block';
    }
  } catch (error) {
    console.error('Error loading more content:', error);
  } finally {
    loading = false;
    loadingIndicator.style.display = 'none';
  }
}

function createContentCard(item) {
  const card = document.createElement('div');
  card.className = 'content-card';
  card.dataset.contentId = item._id;
  
  card.innerHTML = `
    <a href="/content/${item._id}">
      <img src="${item.imageUrl || '/img/placeholder.png'}" alt="${item.title}">
    </a>
    <div class="content-card-body">
      <h5 class="content-card-title">${item.title}</h5>
      ${item.year ? `<small class="text-muted"><i class="bi bi-calendar3"></i> ${item.year}</small>` : ''}
      <div class="d-flex gap-2 mt-2">
        <a href="/player/${item._id}" class="btn btn-play btn-sm">
          <i class="bi bi-play-fill"></i>
        </a>
        <a href="/content/${item._id}" class="btn btn-info btn-sm">
          <i class="bi bi-info-circle"></i>
        </a>
      </div>
    </div>
  `;
  
  return card;
}

// Show loading indicator initially if there might be more content
if (skip === 0) {
  // Load initial content
  loadMoreContent();
}
</script>